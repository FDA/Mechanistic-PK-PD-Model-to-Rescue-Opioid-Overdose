# Scripts to generate the pharmacodynamic results (figures and tables) of _Intranasal Naloxone Repeat Dosing Strategies: A Randomized Clinical Trial and Simulation Study_ 
Mathematical modeling scripts to generate:
* Figures 3 and 4B, and eFigures 1, 2, 3 
* Table 1 and eTable 7

## Authors
FDA/CDER/OTS/OCP/DARS mechanistic modeling team

## Workflow
### Generating Figure 3 and eFigure 1
Executing [SimulateVirtualSubjectsIN4.sh](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/blob/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/SimulateVirtualPopulationsIN4.sh) calls [simulateVirtualSubject.R](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/blob/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/simulateVirtualSubject.R) and necessary 
model files in [models](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/models), 
model parameters in [input](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/input) and 
function files in [functions](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/functions) to generate **Figure 3** and **eFigure 1 A, B, C** in [output/IN4/optimalOutput](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/output/IN4/optimalOutput).

### Generating Figure 4B, eFigure 2 and eFigure 3
1. Execute [SimulateVirtualPopulationsIN4.sh](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/blob/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/SimulateVirtualPopulationsIN4.sh) which generates outcomes for all subjects in the population with IN 4 mg naloxone administration in [output/IN4/individualSubjects*](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/output/IN4).
2. Execute [SimulateVirtualPopulationsIVBoyer.sh](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/blob/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/SimulateVirtualPopulationsIVBoyer.sh) which generates outcomes for all subjects in the population with IV naloxone administration as per the Boyer scheme suggested in [Boyer (2012)](https://www.nejm.org/doi/full/10.1056/NEJMra1202561) in [output/IVBoyer/individualSubjects*](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/output/IVBoyer).
3. Execute [SimulateVirtualPopulationsIVMultipleDoses.sh](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/blob/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/SimulateVirtualPopulationsIVMultipleDoses.sh) which generates outcomes for all subjects in the population with administration of single IV naloxone bolus of varying amount in [output/IVMultipleDoses/individualSubjects*](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/output/IVMultipleDoses).
4. Execute [CalculatePopulationLevelCAMetricsIN4.sh](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/blob/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/CalculatePopulationLevelCAMetricsIN4.sh) which outputs the _percentage of subjects in the population experiencing cardiac arrest_ values with IN 4 mg naloxone administration, to be used in further plotting, in [output/IN4/populationOutput*](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/output/IN4), using the CA outcomes of individual subjects in  [output/IN4/individualSubjects*](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/output/IN4).
5. Execute [CalculatePopulationLevelCAMetricsIVBoyer.sh](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/blob/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/CalculatePopulationLevelCAMetricsIVBoyer.sh) which outputs the _percentage of subjects in the population experiencing cardiac arrest_ values with IV naloxone administration as per the Boyer scheme, to be used in further plotting, in [output/IVBoyer/populationOutput*](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/output/IVBoyer), using the CA outcomes of individual subjects in  [output/IVBoyer/individualSubjects*](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/output/IVBoyer).
6. Execute [CalculatePopulationLevelCAMetricsIVMultipleDoses.sh](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/blob/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/CalculatePopulationLevelCAMetricsIVMultipleDoses.sh) which outputs the _percentage of subjects in the population experiencing cardiac arrest_ values with administration of single IV naloxone bolus of varying amount, to be used in further plotting, in [output/IVMultipleDoses/populationOutput*](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/output/IVMultipleDoses), using the CA outcomes of individual subjects in [output/IVMultipleDoses/individualSubjects*](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/output/IVMultipleDoses).
7. Execute [ForestPlots.sh](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/blob/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/ForestPlots.sh) which produces **Figure 4B**, **eFigure 2** and **eFigure 3** in [output/forestPlots](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/output/forestPlots), using the population level CA percentages in [output/IN4/populationOutput*](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/output/IN4), [output/IVBoyer/populationOutput*](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/output/IVBoyer) and [output/IVMultipleDoses/populationOutput*](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/output/IVMultipleDoses).

### Generating Table 1 and eTable 7
1. Execute [SimulateVirtualPopulationsIN4.sh](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/blob/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/SimulateVirtualPopulationsIN4.sh) which generates outcomes for all subjects in the population with IN 4 mg naloxone administration in [output/IN4/individualSubjects](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/output/IN4/individualSubjects).
2. Execute [CalculatePopulationLevelCAMetricsIN4.sh](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/blob/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/CalculatePopulationLevelCAMetricsIN4.sh) which outputs the _percentage of subjects in the population experiencing cardiac arrest_ values with IN 4 mg naloxone administration, presented in **Table 1**, in [output/IN4/populationOutput](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/output/IN4/populationOutput), using the CA outcomes of individual subjects in  [output/IN4/individualSubjects](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/output/IN4/individualSubjects).
3. Execute [CalculatePopulationLevelRTMetricsIN4.sh](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/blob/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/CalculatePopulationLevelRTMetricsIN4.sh) which outputs the time below (or above) various physiological parameter values with IN 4 mg naloxone administration, presented in both the tables, in [output/IN4/populationOutput](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/output/IN4/populationOutput), using the corresponding values of individual subjects in  [output/IN4/individualSubjects](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/output/IN4/individualSubjects).

## Brief description of models and parameters
### Models
The model for simulating the effect of IN 4 mg naloxone administration on IV opioid induced respiratory depression (OIRD) can be found in [models/modelINRepeatedDosing](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/models/modelINRepeatedDosing) and the model for simulating the effect of IV naloxone administration of varying amount on OIRD can be found in [models/modelIV](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/models/modelIV). In each of these two folders _delaymymod_ files contain the model equations described in detail in [Mann et al.](https://pubmed.ncbi.nlm.nih.gov/35766413/) and other files serve as auxillary files. 

### Parameters
The parameters for a "typical" patient can be found in [input/optimalParameters](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/input/optimalParameters). The opioid (fentanyl and carfentanil) pharmacokinetic and receptor binding parameters are available in [input/optimalParameters/opioid](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/input/optimalParameters/opioid). Receptor binding parameters for naloxone (same for both IN and IV naloxone) and the pharmacokinetic parameters of IN and IV naloxone are provided in [input/optimalParameters/antagonist](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/input/optimalParameters/antagonist). The parameters representing various physiological variables which are used in the physiological and ventilatory component of the model are provided in [input/optimalParameters/physiological/physiologicalParameters](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/blob/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/input/optimalParameters/physiological/physiologicalParameters.R
). The pharmacodynamic parameters for a chronic opioid user is given in [input/optimalParameters/subject/chronic](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/blob/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/input/optimalParameters/subject/chronic.R). 

The corresponding parameters for all of the 2000 subjects in the virtual population are availalable in 
[input/populationParameters](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/input/populationParameters). The opioid pharmacokinetic and receptor binding parameters are available in [input/populationParameters/opioid](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/input/populationParameters/opioid). Similar to the "typical" patient, fentanyl pharmacokinetic parameters are modified to match a longer half-life for carfentanil. The naloxone receptor binding parameters and IN and IV naloxone pharmacokinetic parameters are available in [input/populationParameters/antagonist](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/tree/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/input/populationParameters/antagonist). 

Additional simulation related parameters used both for simulating the "typical" patient as well as the virtual population are defined in [input/simulationParameters](https://github.com/FDA/Mechanistic-PK-PD-Model-to-Rescue-Opioid-Overdose/blob/Intranasal-Naloxone-Repeat-Dosing-Strategies-and-Fentayl-Overdose/pharmacodynamicFigures/input/simulationParameters.R).

## Requirements
These codes were developed with R (version 4.0.2) and use the following packages:
*	deSolve (version 1.30)
*	ggplot2 (version 3.1.1)
*	gridExtra (version 2.2.1)
*	optparse (version 1.4.4)


